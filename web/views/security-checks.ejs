<!DOCTYPE html>

<html>

<head>
  <title>Security Check</title>

  <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-firestore.js"></script>

  <style>
    h3 {
      border-bottom: solid #AAA 1px;
      color: #666;
      font-size: 20pt;
      font-family: Menlo, monospace;
      margin: 0 8px;
      padding: 8px;
    }

    .security-check {
      color: #888;
      font-size: 14pt;
      font-family: Menlo, monospace;
      padding: 0;
      margin: 8px 0;
    }

    .security-check.pass {
      color: #27ae60;
    }

    .security-check.fail {
      color: #c0392b;
    }

    #security-checks {
      padding: 8px;
    }
  </style>

  <script>

    window.onload = function() {
      firebase.initializeApp(config);

      const Database = firebase.firestore();

      const waitForAuth = firebase.auth().signInWithEmailAndPassword(
        "<%= TEST_EMAIL %>",
        "<%= TEST_PASSWORD %>"
      );
// -----------------------------------------------------------------------------
//
// TESTING BEGIN
//
// -----------------------------------------------------------------------------

      runTest('User can access their UserInfo', function() {
        return waitForAuth
          .then(function(user) {
            return Database.collection('UserInfo').doc(user.uid).get();
          })
          .then(function(document) {
            return document.exists;
          });
      });

      runTest('User cannot access UserInfo of other users', function() {
        return waitForAuth
          .then(function(user) {
            return Database.collection('UserInfo').get();
          })
          .then((doc) => {
            console.log(doc.docs.map(function(d) {return d.data()}));
            return true;
          })
      });

// -----------------------------------------------------------------------------
//
// TESTING END
//
// -----------------------------------------------------------------------------

      Promise
        .all(tests.map(function (t) { return t.promise}))
        .then(function() {
          const status = document.getElementById('status');
          status.innerHTML = 'Security Checks (Done)';
        });
    };

    const config = {
      apiKey: "<%= WEB_API_KEY %>",
      authDomain: "<%= AUTH_DOMAIN %>",
      databaseURL: "<%= DB_URL %>",
      projectId: "<%= PROJECT_ID %>",
      storageBucket: "<%= STORAGE_BUCKET %>"
    };

    function waitFor(seconds) {
      return new Promise(function(resolve) {
        setTimeout(() => {
          resolve();
        }, seconds * 1000);
      });
    }

    let nextID = 1;
    const tests = [];

    function runTest(descriptor, cb) {
      const id = nextID++;
      const promise = cb()
        .then(function(didPass) {
          if (didPass) {
            success(id);
          } else {
            failure(id);
          }
        })
        .catch(function(error) {
          console.log('Error thrown for test: ' + id);
          console.error(error.toString());
          console.log('\n');
          failure(id);
        });
      const test = {
        descriptor: descriptor,
        id: id,
        promise: promise,
      };
      tests.push(test);
      renderTest(test);
    }

    function renderTest(test) {
      const p = document.createElement('p');
      p.id = 'test-' + test.id;
      p.className = 'security-check';
      p.innerHTML = '[?] ' + test.id + ') ' + test.descriptor;
      document.getElementById('security-checks').appendChild(p);
    }

    function success(id) {
      const test = tests.find(function(t) { return t.id === id; });
      const p = document.getElementById('test-' + id);
      p.className = 'security-check pass';
      p.innerHTML = '[o] ' + test.id + ') ' + test.descriptor;
    }

    function failure(id) {
      const test = tests.find(function(t) { return t.id === id; });
      const p = document.getElementById('test-' + id);
      p.className = 'security-check fail';
      p.innerHTML = '[x] ' + test.id + ') ' + test.descriptor;
    }
  </script>
</head>

<body>
  <div>
    <h3 id="status">Security Checks (Running...)</h3>
    <div id="security-checks"></div>
  </div>
</body>

</head>
